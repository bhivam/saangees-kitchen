# Progress Log

## 2026-01-18

### Phase 1: Backend Changes - Task 2: Add `convertCustomToNormal` mutation

**Status**: ✅ Completed

**What was done**:
- Discovered that Task 1 (`createCustomMenuEntry` duplicate prevention) was already implemented in `backend/src/trpc/router/menu.ts:239-272`
- Added new `convertCustomToNormal` mutation to `backend/src/trpc/router/menu.ts:324-355`
  - Takes an `entryId` (UUID) as input
  - Finds the menu entry and returns error if not found
  - If already a normal entry, returns it unchanged
  - Otherwise, updates `isCustom` to `false` and returns the updated entry
- This mutation allows converting custom menu entries to normal entries when they are added to the Menu Editor

**Files modified**:
- `backend/src/trpc/router/menu.ts` - Added `convertCustomToNormal` mutation

**Next task**: Phase 1, Task 3 - Fix `updateManualOrder` to preserve items and validate due dates

---

### Phase 1: Backend Changes - Task 3: Fix `updateManualOrder` to preserve items and validate due dates

**Status**: ✅ Completed

**What was done**:

**Backend changes** (`backend/src/trpc/router/order.ts:698-926`):
- Extended input schema to accept `orderItemId?: string` for existing items
- Fetches existing order items with their menu entries for due date validation
- Added server-side due date validation:
  - Compares item quantity and modifiers to detect modifications
  - Rejects modifications to items whose menu entry date is in the past
  - Rejects deletion of past-due items
- Changed update logic to:
  - UPDATE existing items (with `orderItemId`) instead of DELETE/INSERT - preserves `baggedAt` timestamps
  - INSERT new items (without `orderItemId`)
  - DELETE only items that are no longer in the list (and not past-due)

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `orderItemId?: string` field to `OrderItem` interface
- When loading edit data, populate `orderItemId` from `item.id` for each existing item
- Updated `handleSubmit` to include `orderItemId` in the update mutation payload

**Files modified**:
- `backend/src/trpc/router/order.ts` - Rewrote `updateManualOrder` mutation
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Added `orderItemId` tracking

**Next task**: Phase 2, Task 1 - Add sorting state and logic to manual-entry-table.tsx

---

### Phase 2: Table Enhancements - Task 1: Add sorting state and logic

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added sorting state with `sortField` (user | date | total) and `sortDirection` (asc | desc)
- Default sort is by date descending (newest first)
- Added `sortedOrders` useMemo that sorts `filteredOrders` based on current sort state
- Added `handleSort` function that toggles direction when clicking same field, or sets new field with asc direction
- Added `SortIcon` component that displays ArrowUpDown (unsorted), ArrowUp (asc), or ArrowDown (desc)
- Made User, Date Submitted, and Total column headers clickable with sort indicators
- Imported ArrowDown, ArrowUp, ArrowUpDown icons from lucide-react

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added sorting functionality

**Next task**: Phase 2, Task 2 - Add pagination state and logic to manual-entry-table.tsx

---

### Phase 2: Table Enhancements - Task 2: Add pagination state and logic

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added `ITEMS_PER_PAGE` constant (10 items per page)
- Added `currentPage` state starting at 1
- Added pagination calculations: `totalPages` and `paginatedOrders` slice
- Added `useEffect` to reset to page 1 when search changes
- Added `getPageNumbers` helper function that generates page numbers with ellipsis for large page counts:
  - Shows all pages if totalPages <= 7
  - Otherwise shows first page, ellipsis, current ±1, ellipsis, last page
- Changed table body to render `paginatedOrders` instead of `sortedOrders`
- Added Pagination UI component below the table (only shown when totalPages > 1):
  - Previous/Next buttons with disabled styling when at bounds
  - Page number links with active state indication
  - Ellipsis for large page counts
- Imported Pagination components from `../ui/pagination`

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added pagination functionality

**Next task**: Phase 2, Task 3 - Add view-only button for customer orders

---

### Phase 2: Table Enhancements - Task 3: Add view-only button for customer orders

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added `viewOrder` state to track the order being viewed (separate from `editOrder`)
- Changed Edit button logic: manual orders (`isManual=true`) show Edit icon and set `editOrder`, customer orders (`isManual=false`) show Eye icon and set `viewOrder`
- Added a second `AddManualOrderDialog` instance for view-only mode with `viewOnly` prop
- Imported `Eye` icon from lucide-react

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `viewOnly?: boolean` prop to `AddManualOrderDialogProps` interface
- Passed `viewOnly` prop through to `AddManualOrderDialogContent`
- In view-only mode:
  - Dialog title changes to "View Order"
  - "Add Item" button is hidden
  - Trash button is hidden for each item (shows quantities as read-only text)
  - Footer shows only "Close" button (no Cancel/Submit buttons)
- Fixed description to show user name from `editData` when `selectedUser` is not available

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added Eye/Edit icon logic and viewOrder state
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Added viewOnly prop support

**Next task**: Phase 3, Task 1 - Replace date input with DayPicker

---

### Phase 3: Dialog Enhancements - Task 1: Replace date input with DayPicker

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added imports for `DayPicker` from `react-day-picker` and its CSS
- Added import for `toLocalDateString` utility from `@/lib/utils`
- Changed `selectedDate` state from `string` to `Date | undefined`, initialized to `new Date()`
- Updated `dateMenuEntries` useMemo to convert `selectedDate` to string using `toLocalDateString()` for comparison
- Updated custom entry creation to guard against undefined `selectedDate` and convert using `toLocalDateString()`
- Replaced native `<Input type="date">` with inline `<DayPicker>` component:
  - Uses `mode="single"` for single date selection
  - Wrapped in a centered, bordered container for consistent styling
  - Connects `selected` and `onSelect` to the `selectedDate` state

**Files modified**:
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Replaced date input with DayPicker

**Next task**: Phase 3, Task 2 - Reorganize item selection UI (grouped by day + All Items)

---

### Phase 3: Dialog Enhancements - Tasks 2 & 3: Reorganize item selection UI + Create Item button

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added imports for `ChevronDown`, `ChevronRight` icons and `formatDate` utility
- Added import for `AddItemDialog` component
- Added new state:
  - `expandedDays` - tracks which day sections are expanded in the grouped view
  - `allItemsExpanded` - tracks if "All Items" section is expanded
  - `addItemDialogOpen` - controls the AddItemDialog visibility
- Added `next7Days` useMemo to get dates for next 7 days
- Added `menuEntriesByDay` useMemo to group menu entries by date
- Added helper functions:
  - `handleNewItemCreated` - handles when a new item is created via AddItemDialog, auto-creates custom entry and selects it for modifier configuration
  - `handleSelectEntry` - handles selecting an entry from the grouped list
  - `handleSelectMenuItem` - handles creating a custom entry from "All Items" section
- Completely rewrote the "addItem" step UI:
  - DayPicker calendar at the top
  - "Menu Items (7 days)" collapsible section showing entries grouped by date
  - Each day is expandable/collapsible with item count badge
  - "All Items" collapsible section with a "Create Item" button
  - `AddItemDialog` integration with `onCreated` callback
- Removed unused `dateMenuEntries` variable (replaced by grouped view)

**Frontend changes** (`frontend/src/components/add-item-dialog.tsx`):
- Added `onCreated?: (item: MenuItemResult) => void` prop to `AddItemDialogProps`
- Passed `onCreated` prop through to `useAddItemForm` hook

**Frontend changes** (`frontend/src/hooks/use-add-item-form.ts`):
- Added `onCreated?: (item: MenuItemResult) => void` parameter
- Updated `onSubmit` handler to call `onCreated` callback after item is successfully created

**Files modified**:
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Reorganized item selection UI
- `frontend/src/components/add-item-dialog.tsx` - Added onCreated callback prop
- `frontend/src/hooks/use-add-item-form.ts` - Added onCreated callback support

**Next task**: Phase 3, Task 4 - Replace trash with QuantityStepper

---

### Phase 3: Dialog Enhancements - Task 4: Replace trash with QuantityStepper

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added import for `QuantityStepper` component from `../quantity-stepper`
- Changed `Trash` icon import to `Trash2` for use as the reduce icon when quantity is 1
- Added `updateItemQuantity` function to update an item's quantity at a specific index
- Replaced the Trash button in the items list with `QuantityStepper`:
  - Shows quantity value with +/- buttons
  - When quantity is 1, the reduce button shows a Trash2 icon and removes the item
  - When quantity > 1, the reduce button decrements the quantity
  - Increase button increments the quantity
  - In view-only mode, shows just "×{quantity}" text instead of the stepper
- Removed the redundant quantity prefix from item name (since quantity is now shown in the stepper)

**Files modified**:
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Replaced trash button with QuantityStepper

**Note**: Task 5 (`viewOnly` prop support) was already implemented as part of Phase 2, Task 3, so it's marked as complete in the PRD.

**Next task**: Phase 3, Task 6 - Add per-item due date validation

---

### Phase 3: Dialog Enhancements - Task 6: Add per-item due date validation

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `menuEntryDate` field to the `OrderItem` interface to store the menu entry date (YYYY-MM-DD format)
- Updated the edit data loading to populate `menuEntryDate` from `item.menuEntry.date`
- Updated `addItemToOrder` function to include `menuEntryDate` from `selectedMenuEntry.date` when adding new items
- Added `isItemPastDue` helper function that compares the item's menu entry date with today's date:
  - Returns `true` if the entry date is before today
  - Uses local date comparison to avoid timezone issues
- Updated the items list rendering to use `isItemPastDue`:
  - Past-due items display with reduced opacity (`opacity-60`)
  - Past-due items show "Past due - locked" text in amber color (only when not in view-only mode)
  - QuantityStepper is disabled for past-due items (`reduceDisabled` and `increaseDisabled` set to `true`)

**Note**: Server-side due date validation was already implemented in Phase 1, Task 3. This task completes the client-side validation to provide immediate feedback to users.

**Files modified**:
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Added client-side per-item due date validation

---

### Phase 3: Dialog Enhancements - Task 7: Track `orderItemId` for proper updates

**Status**: ✅ Already Completed (in Phase 1, Task 3)

**What was done**:

This task was already fully implemented as part of Phase 1, Task 3 ("Fix `updateManualOrder` to preserve items and validate due dates"). The implementation included:

**Backend** (`backend/src/trpc/router/order.ts`):
- Extended input schema to accept `orderItemId?: string` for existing items
- For items with `orderItemId`: UPDATE instead of DELETE/INSERT (preserves `baggedAt` timestamps)
- For new items (without `orderItemId`): INSERT
- Delete items that are no longer in the list (and not past-due)

**Frontend** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `orderItemId?: string` field to `OrderItem` interface
- When loading edit data, populate `orderItemId` from `item.id` for each existing item
- Updated `handleSubmit` to include `orderItemId` in the update mutation payload

**PRD Update**:
- Marked Phase 3, Task 7 as complete with note "(already implemented in Phase 1, Task 3)"

**Result**: All tasks in the PRD are now complete.

---

## PRD COMPLETE

All phases and tasks have been implemented:
- Phase 1: Backend Changes (3/3 tasks) ✅
- Phase 2: Table Enhancements (3/3 tasks) ✅
- Phase 3: Dialog Enhancements (7/7 tasks) ✅
