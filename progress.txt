# Progress Log

## 2026-01-18

### Phase 1: Backend Changes - Task 2: Add `convertCustomToNormal` mutation

**Status**: ✅ Completed

**What was done**:
- Discovered that Task 1 (`createCustomMenuEntry` duplicate prevention) was already implemented in `backend/src/trpc/router/menu.ts:239-272`
- Added new `convertCustomToNormal` mutation to `backend/src/trpc/router/menu.ts:324-355`
  - Takes an `entryId` (UUID) as input
  - Finds the menu entry and returns error if not found
  - If already a normal entry, returns it unchanged
  - Otherwise, updates `isCustom` to `false` and returns the updated entry
- This mutation allows converting custom menu entries to normal entries when they are added to the Menu Editor

**Files modified**:
- `backend/src/trpc/router/menu.ts` - Added `convertCustomToNormal` mutation

**Next task**: Phase 1, Task 3 - Fix `updateManualOrder` to preserve items and validate due dates

---

### Phase 1: Backend Changes - Task 3: Fix `updateManualOrder` to preserve items and validate due dates

**Status**: ✅ Completed

**What was done**:

**Backend changes** (`backend/src/trpc/router/order.ts:698-926`):
- Extended input schema to accept `orderItemId?: string` for existing items
- Fetches existing order items with their menu entries for due date validation
- Added server-side due date validation:
  - Compares item quantity and modifiers to detect modifications
  - Rejects modifications to items whose menu entry date is in the past
  - Rejects deletion of past-due items
- Changed update logic to:
  - UPDATE existing items (with `orderItemId`) instead of DELETE/INSERT - preserves `baggedAt` timestamps
  - INSERT new items (without `orderItemId`)
  - DELETE only items that are no longer in the list (and not past-due)

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `orderItemId?: string` field to `OrderItem` interface
- When loading edit data, populate `orderItemId` from `item.id` for each existing item
- Updated `handleSubmit` to include `orderItemId` in the update mutation payload

**Files modified**:
- `backend/src/trpc/router/order.ts` - Rewrote `updateManualOrder` mutation
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Added `orderItemId` tracking

**Next task**: Phase 2, Task 1 - Add sorting state and logic to manual-entry-table.tsx

---

### Phase 2: Table Enhancements - Task 1: Add sorting state and logic

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added sorting state with `sortField` (user | date | total) and `sortDirection` (asc | desc)
- Default sort is by date descending (newest first)
- Added `sortedOrders` useMemo that sorts `filteredOrders` based on current sort state
- Added `handleSort` function that toggles direction when clicking same field, or sets new field with asc direction
- Added `SortIcon` component that displays ArrowUpDown (unsorted), ArrowUp (asc), or ArrowDown (desc)
- Made User, Date Submitted, and Total column headers clickable with sort indicators
- Imported ArrowDown, ArrowUp, ArrowUpDown icons from lucide-react

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added sorting functionality

**Next task**: Phase 2, Task 2 - Add pagination state and logic to manual-entry-table.tsx

---

### Phase 2: Table Enhancements - Task 2: Add pagination state and logic

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added `ITEMS_PER_PAGE` constant (10 items per page)
- Added `currentPage` state starting at 1
- Added pagination calculations: `totalPages` and `paginatedOrders` slice
- Added `useEffect` to reset to page 1 when search changes
- Added `getPageNumbers` helper function that generates page numbers with ellipsis for large page counts:
  - Shows all pages if totalPages <= 7
  - Otherwise shows first page, ellipsis, current ±1, ellipsis, last page
- Changed table body to render `paginatedOrders` instead of `sortedOrders`
- Added Pagination UI component below the table (only shown when totalPages > 1):
  - Previous/Next buttons with disabled styling when at bounds
  - Page number links with active state indication
  - Ellipsis for large page counts
- Imported Pagination components from `../ui/pagination`

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added pagination functionality

**Next task**: Phase 2, Task 3 - Add view-only button for customer orders

---

### Phase 2: Table Enhancements - Task 3: Add view-only button for customer orders

**Status**: ✅ Completed

**What was done**:

**Frontend changes** (`frontend/src/components/orders/manual-entry-table.tsx`):
- Added `viewOrder` state to track the order being viewed (separate from `editOrder`)
- Changed Edit button logic: manual orders (`isManual=true`) show Edit icon and set `editOrder`, customer orders (`isManual=false`) show Eye icon and set `viewOrder`
- Added a second `AddManualOrderDialog` instance for view-only mode with `viewOnly` prop
- Imported `Eye` icon from lucide-react

**Frontend changes** (`frontend/src/components/orders/add-manual-order-dialog.tsx`):
- Added `viewOnly?: boolean` prop to `AddManualOrderDialogProps` interface
- Passed `viewOnly` prop through to `AddManualOrderDialogContent`
- In view-only mode:
  - Dialog title changes to "View Order"
  - "Add Item" button is hidden
  - Trash button is hidden for each item (shows quantities as read-only text)
  - Footer shows only "Close" button (no Cancel/Submit buttons)
- Fixed description to show user name from `editData` when `selectedUser` is not available

**Files modified**:
- `frontend/src/components/orders/manual-entry-table.tsx` - Added Eye/Edit icon logic and viewOrder state
- `frontend/src/components/orders/add-manual-order-dialog.tsx` - Added viewOnly prop support

**Next task**: Phase 3, Task 1 - Replace date input with DayPicker
